name: Build Node.js ARM64 with glibc 2.27

on:
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node.js version (e.g., 22.21.1)'
        required: true
        default: '22.21.1'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Build Node.js
        run: |
          docker run --rm --platform linux/arm64 -v $PWD:/work -w /work ubuntu:18.04 bash -c '
            set -eux
            # Note: Using -eux instead of -euxo pipefail to avoid SIGPIPE issues with head/grep
            export DEBIAN_FRONTEND=noninteractive
            
            echo "=== System Information ==="
            uname -a
            cat /etc/os-release
            ldd --version | head -n1 || true
            
            apt-get update
            
            # Basic utilities + repos support
            apt-get install -y software-properties-common wget git ca-certificates curl xz-utils
            
            # Toolchain PPA for GCC 10 and deadsnakes for Python 3.8
            add-apt-repository -y ppa:ubuntu-toolchain-r/test
            add-apt-repository -y ppa:deadsnakes/ppa
            apt-get update
            
            # Install compilers + build deps
            apt-get install -y gcc-10 g++-10 make build-essential \
               python3.8 python3.8-dev python3.8-distutils pkg-config libssl-dev \
               gperf bison xz-utils
            
            echo "=== Compiler Versions ==="
            gcc-10 --version | head -n1 || true
            g++-10 --version | head -n1 || true
            python3.8 --version
            
            # Download Node.js source
            NODE_VERSION=${{ github.event.inputs.node_version }}
            echo "=== Downloading Node.js v${NODE_VERSION} ==="
            cd /tmp
            wget -q https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}.tar.gz
            tar -xzf node-v${NODE_VERSION}.tar.gz
            cd node-v${NODE_VERSION}
            
            echo "=== Configuring Node.js ==="
            CC=/usr/bin/gcc-10 CXX=/usr/bin/g++-10 python3.8 configure.py --prefix=/opt/nodejs
            
            echo "=== Building Node.js ==="
            echo "Attempting parallel build with $(nproc) cores..."
            
            # Try parallel build; if it fails, retry single-threaded
            set +e
            CC=/usr/bin/gcc-10 CXX=/usr/bin/g++-10 make -j$(nproc)
            RC=$?
            if [ $RC -ne 0 ]; then
              echo "⚠️  Parallel build failed (exit $RC). Retrying single-threaded..."
              CC=/usr/bin/gcc-10 CXX=/usr/bin/g++-10 make -j1 || exit 1
            fi
            set -e
            
            echo "=== Installing Node.js ==="
            make install DESTDIR=/work/node-output
            
            echo "=== Creating tarball ==="
            cd /work/node-output/opt/nodejs
            tar -czf /work/node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.gz .
            
            echo ""
            echo "✅ Build completed successfully!"
            ls -lh /work/node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.gz
          '
      
      - name: Verify build
        run: |
          sudo apt-get update
          sudo apt-get install -y binutils-aarch64-linux-gnu file
          
          mkdir -p test-extract
          tar -xzf node-v${{ github.event.inputs.node_version }}-linux-arm64-glibc-227.tar.gz -C test-extract
          
          echo "=== Architecture Verification ==="
          file test-extract/bin/node
          
          ARCH=$(aarch64-linux-gnu-readelf -h test-extract/bin/node | grep Machine | awk '{print $2}')
          if [[ "$ARCH" == "AArch64" ]]; then
            echo "✅ Confirmed: ARM64 (aarch64) binary"
          else
            echo "❌ ERROR: Not an ARM64 binary!"
            exit 1
          fi
          
          echo ""
          echo "=== glibc Requirements ==="
          aarch64-linux-gnu-readelf -V test-extract/bin/node | grep "GLIBC_" | sort -V | uniq | tail -3
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-v${{ github.event.inputs.node_version }}-linux-arm64-glibc-227
          path: node-v${{ github.event.inputs.node_version }}-linux-arm64-glibc-227.tar.gz
          retention-days: 30
      
      - name: Summary
        run: |
          FILE_SIZE=$(ls -lh node-v${{ github.event.inputs.node_version }}-linux-arm64-glibc-227.tar.gz | awk '{print $5}')
          
          echo "# ✅ Node.js v${{ github.event.inputs.node_version }} ARM64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** ARM64 (aarch64)" >> $GITHUB_STEP_SUMMARY
          echo "**glibc:** ≥ 2.27" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${FILE_SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from **Artifacts** above." >> $GITHUB_STEP_SUMMARY
