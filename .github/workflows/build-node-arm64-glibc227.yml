name: Build Node.js ARM64 with glibc 2.27 (Fixed)

on:
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node.js version (e.g., 22.21.1)'
        required: true
        default: '22.21.1'

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 600
    steps:
      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget curl git python3 make pkg-config ccache \
            gcc-10 g++-10 \
            gcc-10-aarch64-linux-gnu g++-10-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            file xz-utils
      
      - name: Create Ubuntu 18.04 ARM64 sysroot (glibc 2.27)
        run: |
          # Create sysroot directory
          sudo mkdir -p /opt/sysroot-bionic-arm64
          cd /tmp
          
          # Base URL for Ubuntu 18.04 ARM64 packages
          BASE_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main"
          
          # Essential packages with correct paths
          declare -A PACKAGES=(
            ["libc6"]="g/glibc/libc6_2.27-3ubuntu1.6_arm64.deb"
            ["libc6-dev"]="g/glibc/libc6-dev_2.27-3ubuntu1.6_arm64.deb"
            ["libssl1.1"]="o/openssl/libssl1.1_1.1.1-1ubuntu2.1~18.04.23_arm64.deb"
            ["libssl-dev"]="o/openssl/libssl-dev_1.1.1-1ubuntu2.1~18.04.23_arm64.deb"
            ["zlib1g"]="z/zlib/zlib1g_1.2.11.dfsg-0ubuntu2_arm64.deb"
            ["zlib1g-dev"]="z/zlib/zlib1g-dev_1.2.11.dfsg-0ubuntu2_arm64.deb"
            ["linux-libc-dev"]="l/linux/linux-libc-dev_4.15.0-213.224_arm64.deb"
          )
          
          echo "Downloading Ubuntu 18.04 ARM64 packages for sysroot..."
          for pkg_name in "${!PACKAGES[@]}"; do
            pkg_path="${PACKAGES[$pkg_name]}"
            url="${BASE_URL}/${pkg_path}"
            filename=$(basename "$pkg_path")
            
            echo "  Downloading $filename..."
            if wget -q "$url" -O "$filename"; then
              echo "    âœ“ Downloaded successfully"
              sudo dpkg-deb -x "$filename" /opt/sysroot-bionic-arm64/
              echo "    âœ“ Extracted to sysroot"
            else
              echo "    âœ— Failed to download, trying alternate..."
              # Try without version suffix
              alt_filename="${pkg_name}_arm64.deb"
              if wget -q "${BASE_URL}/$(dirname $pkg_path)/${alt_filename}" -O "$filename" 2>/dev/null; then
                echo "    âœ“ Downloaded alternate version"
                sudo dpkg-deb -x "$filename" /opt/sysroot-bionic-arm64/
              else
                echo "    âš  Skipping $pkg_name"
              fi
            fi
          done
          
          # Clean up
          rm -f *.deb
          
          # Verify critical files exist
          echo ""
          echo "=== Verifying sysroot ==="
          if [ -f /opt/sysroot-bionic-arm64/lib/aarch64-linux-gnu/libc.so.6 ]; then
            echo "âœ“ libc found"
          else
            echo "âœ— libc NOT found - build may fail"
          fi
          
          if [ -d /opt/sysroot-bionic-arm64/usr/include ]; then
            echo "âœ“ Headers found"
          else
            echo "âœ— Headers NOT found - build may fail"
          fi
          
          echo ""
          echo "=== Sysroot structure ==="
          ls -la /opt/sysroot-bionic-arm64/
          echo ""
          ls -la /opt/sysroot-bionic-arm64/lib/aarch64-linux-gnu/ 2>/dev/null | head -10 || echo "lib directory structure different"
          echo ""
          ls -la /opt/sysroot-bionic-arm64/usr/include/ 2>/dev/null | head -10 || echo "include directory structure different"
      
      - name: Download Node.js source
        run: |
          NODE_VERSION=${{ github.event.inputs.node_version }}
          wget -q "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}.tar.gz"
          tar -xzf "node-v${NODE_VERSION}.tar.gz"
          
          echo "âœ“ Node.js ${NODE_VERSION} source extracted"
      
      - name: Configure Node.js for cross-compilation
        run: |
          NODE_VERSION=${{ github.event.inputs.node_version }}
          cd "node-v${NODE_VERSION}"
          
          # Set up cross-compilation environment
          export CC_host=/usr/bin/gcc-10
          export CXX_host=/usr/bin/g++-10
          export LINK_host=/usr/bin/g++-10
          export CC=/usr/bin/aarch64-linux-gnu-gcc-10
          export CXX=/usr/bin/aarch64-linux-gnu-g++-10
          export AR=/usr/bin/aarch64-linux-gnu-ar
          export RANLIB=/usr/bin/aarch64-linux-gnu-ranlib
          export LINK=/usr/bin/aarch64-linux-gnu-g++-10
          
          # Point to Ubuntu 18.04 sysroot for glibc 2.27
          export CFLAGS="--sysroot=/opt/sysroot-bionic-arm64"
          export CXXFLAGS="--sysroot=/opt/sysroot-bionic-arm64"
          export LDFLAGS="--sysroot=/opt/sysroot-bionic-arm64"
          
          echo "=== Cross-compilation environment ==="
          echo "Host compiler: $($CC_host --version | head -1)"
          echo "Target compiler: $($CC --version | head -1)"
          echo "Sysroot: $CFLAGS"
          
          # Configure
          echo ""
          echo "=== Configuring Node.js ==="
          python3 configure.py \
            --dest-cpu=arm64 \
            --cross-compiling \
            --prefix=/opt/nodejs \
            --without-inspector \
            --without-intl \
            --openssl-no-asm
          
          echo ""
          echo "âœ“ Configuration complete"
      
      - name: Build Node.js
        run: |
          NODE_VERSION=${{ github.event.inputs.node_version }}
          cd "node-v${NODE_VERSION}"
          
          # Set environment again for build
          export CC_host=/usr/bin/gcc-10
          export CXX_host=/usr/bin/g++-10
          export LINK_host=/usr/bin/g++-10
          export CC=/usr/bin/aarch64-linux-gnu-gcc-10
          export CXX=/usr/bin/aarch64-linux-gnu-g++-10
          export AR=/usr/bin/aarch64-linux-gnu-ar
          export RANLIB=/usr/bin/aarch64-linux-gnu-ranlib
          export LINK=/usr/bin/aarch64-linux-gnu-g++-10
          export CFLAGS="--sysroot=/opt/sysroot-bionic-arm64"
          export CXXFLAGS="--sysroot=/opt/sysroot-bionic-arm64"
          export LDFLAGS="--sysroot=/opt/sysroot-bionic-arm64"
          
          echo "=== Building Node.js ==="
          echo "This will take approximately 20-40 minutes..."
          echo "Start time: $(date)"
          
          # Build with moderate parallelism to avoid memory issues
          make -j4 V=0
          
          echo ""
          echo "End time: $(date)"
          echo "âœ“ Build complete!"
      
      - name: Create installation package
        run: |
          NODE_VERSION=${{ github.event.inputs.node_version }}
          cd "node-v${NODE_VERSION}"
          
          # Install to temporary directory
          mkdir -p ../node-install
          make install DESTDIR=$PWD/../node-install
          
          # Navigate to installation
          cd ../node-install/opt/nodejs
          
          # Verify binary
          echo "=== Binary verification ==="
          file bin/node
          
          if file bin/node | grep -q "ARM aarch64"; then
            echo "âœ“ Binary is ARM64"
          else
            echo "âœ— Binary is not ARM64!"
            file bin/node
            exit 1
          fi
          
          # Create tarballs
          echo ""
          echo "=== Creating distribution packages ==="
          
          # .tar.gz
          tar -czf "/tmp/node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.gz" \
            --transform "s|^|node-v${NODE_VERSION}-linux-arm64-glibc-227/|" \
            *
          
          # .tar.xz (better compression)
          XZ_OPT=-9 tar -cJf "/tmp/node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.xz" \
            --transform "s|^|node-v${NODE_VERSION}-linux-arm64-glibc-227/|" \
            *
          
          echo "âœ“ Packages created!"
      
      - name: Verify and create checksums
        run: |
          NODE_VERSION=${{ github.event.inputs.node_version }}
          
          # Create artifacts directory
          mkdir -p artifacts
          mv /tmp/node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.* artifacts/
          
          # Verify extraction
          cd artifacts
          echo "=== Testing package extraction ==="
          tar -xzf "node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.gz"
          
          # Test what glibc versions are required
          echo ""
          echo "=== glibc version requirements ==="
          readelf -V "node-v${NODE_VERSION}-linux-arm64-glibc-227/bin/node" | grep GLIBC | sort -u || echo "No GLIBC symbols detected"
          
          # Check actual binary
          echo ""
          file "node-v${NODE_VERSION}-linux-arm64-glibc-227/bin/node"
          
          # Remove test extraction
          rm -rf "node-v${NODE_VERSION}-linux-arm64-glibc-227"
          
          # Create checksums
          sha256sum *.tar.* > SHASUMS256.txt
          
          echo ""
          echo "=== Final artifacts ==="
          ls -lh
          echo ""
          echo "=== Checksums ==="
          cat SHASUMS256.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: node-v${{ github.event.inputs.node_version }}-linux-arm64-glibc-227
          path: artifacts/*
          retention-days: 30
      
      - name: Generate summary
        run: |
          NODE_VERSION=${{ github.event.inputs.node_version }}
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## âœ… Node.js ARM64 Build Complete!
          
          **Version:** v${NODE_VERSION}  
          **Architecture:** linux-arm64  
          **glibc:** 2.27 (Ubuntu 18.04, Debian 10, RHEL 8 compatible)  
          **Build Method:** Cross-compilation with Ubuntu 18.04 sysroot
          
          ### ðŸ“¦ Artifacts Created
          
          - \`node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.gz\`
          - \`node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.xz\` (smaller)
          - \`SHASUMS256.txt\`
          
          ### ðŸš€ Installation
          
          \`\`\`bash
          # Download the artifact from this workflow
          tar -xzf node-v${NODE_VERSION}-linux-arm64-glibc-227.tar.gz
          sudo mv node-v${NODE_VERSION}-linux-arm64-glibc-227 /opt/nodejs
          sudo ln -s /opt/nodejs/bin/node /usr/local/bin/node
          sudo ln -s /opt/nodejs/bin/npm /usr/local/bin/npm
          
          # Verify
          node --version
          \`\`\`
          
          ### âœ… Compatibility
          
          This build works on:
          - Ubuntu 18.04+ ARM64
          - Debian 10+ ARM64  
          - RHEL 8+ ARM64
          - Any ARM64 Linux with glibc 2.27+
          EOF
